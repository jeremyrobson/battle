<!doctype html>
<html>

<head>

<script src="jquery-3.2.1.min.js"></script>
<script src="movement.js"></script>
<script src="action.js"></script>
<script src="map.js"></script>
<script src="BattleUnit.js"></script>
<script src="ajax.js"></script>
<script>

const MAP_WIDTH = 20;
const MAP_HEIGHT = 20;
const TILE_WIDTH = 24;
const TILE_HEIGHT = 24;
const UNIT_FONT = "16px Arial";
var canvas, context;
var users, parties, units;
var tiles, nodes, ranges;

function getTileMovementScore(battle, units, unit, x, y) {
    var movementScore = 0;

    units.forEach(function(u) {
        if (u.id === unit.id) {
            return;
        }

        var dx = x - u.x;
        var dy = y - u.y;
        var distance = Math.sqrt(dx*dx + dy*dy);
        if (u.team === unit.team) { //distance from ally
            movementScore += (distance === 0) ? 1 : (1 / distance);
        }
        else { //distance from enemy
            movementScore -= (distance === 0) ? 1 : (1 / distance);
        }
    });
    
    return movementScore;
}

function getTileSafetyScore(battle, units, unit, x, y) {
    var safetyScore = 0;

    units.forEach(function(u) {
        if (u.id === unit.id) {
            return;
        }

        var dx = x - u.x;
        var dy = y - u.y;
        var distance = Math.sqrt(dx*dx + dy*dy);
        if (u.team === unit.team) { //distance from ally
            safetyScore += (distance === 0) ? 1 : (1 / distance);
        }
        else { //distance from enemy
            safetyScore -= (distance === 0) ? 1 : (1 / distance);
        }
    });

    return safetyScore;
}

function loop() {
    draw();
    requestAnimationFrame(loop);
}

function drawNodes(ctx) {
    nodes.forEach(function(node) {
        var r = Math.floor(node.stepScore * 255);
        var g = Math.floor((1-node.stepScore) * 255);
        ctx.fillStyle = "rgba("+r+","+g+",0,1.0)";
        ctx.fillRect(node.x*TILE_WIDTH, node.y*TILE_WIDTH, TILE_WIDTH-1, TILE_WIDTH-1);
    });
}

function drawSafetyScores(ctx) {
    tilelist.forEach(function(t) {
        var r = Math.floor(t.safetyScore * 255);
        var g = Math.floor((1-t.safetyScore) * 255);
        ctx.fillStyle = "rgba("+r+","+g+",0,1.0)";
        ctx.fillRect(t.x*TILE_WIDTH, t.y*TILE_WIDTH, TILE_WIDTH-1, TILE_WIDTH-1);
    });
}

function draw() {
    context.clearRect(0, 0, 640, 480);
    context.shadowBlur = 0;
    context.shadowOffsetX = 0;
    context.shadowOffsetY = 0;
    for (var x=0; x<MAP_WIDTH; x++) {
        for (var y=0; y<MAP_HEIGHT; y++) {
            context.fillStyle = "rgb(0,0,0)";
            context.fillRect(x*TILE_WIDTH, y*TILE_HEIGHT, TILE_WIDTH-1, TILE_HEIGHT-1);
        }
    }

    ranges

    units.forEach(function(u) {
        u.draw(context);
    });
}

function init() {
    var minSafetyScore = 0, maxSafetyScore = 0;

    tiles = generateTiles(MAP_WIDTH, MAP_HEIGHT);

    units.forEach(function(u) {
        tiles[u.x][u.y].addUnit(u);
    });

    /*
    for (var x=0; x<MAP_WIDTH; x++) {
        for (var y=0; y<MAP_HEIGHT; y++) {
            var safetyScore = getTileSafetyScore(null, units, units[1], x, y);
            tilelist.push({
                "x": x,
                "y": y,
                "safetyScore": safetyScore
            });
            minSafetyScore = safetyScore < minSafetyScore ? safetyScore : minSafetyScore;
            maxSafetyScore = safetyScore > maxSafetyScore ? safetyScore : maxSafetyScore;
        }
    }


    //normalize safety scores between 0 and 1
    tilelist.forEach(function(tile) {
        tile.safetyScore = (tile.safetyScore - minSafetyScore) / (maxSafetyScore - minSafetyScore);
    });
    */

    //nodes = getMapNodes(tiles, MAP_WIDTH, MAP_HEIGHT, units, units[0], 100);

    ranges = createDiamond(units[0].x, units[0].y, 7, false);

    requestAnimationFrame(loop);
}

window.onload = function() {
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");

    units = loadUnits(init);
};

</script>

</head>

<body>

<canvas id="canvas" width="640" height="480"></canvas>

</body>

</html>